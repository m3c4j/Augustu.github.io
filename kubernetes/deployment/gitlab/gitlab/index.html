<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.110.0"><meta name=description content><link rel=icon href=/images/favicon.png type=image/png><title>:: 滴滴哒的技术分享</title><link href=/css/nucleus.css?1677150763 rel=stylesheet><link href=/css/fontawesome-all.min.css?1677150763 rel=stylesheet><link href=/css/hybrid.css?1677150763 rel=stylesheet><link href=/css/featherlight.min.css?1677150763 rel=stylesheet><link href=/css/perfect-scrollbar.min.css?1677150763 rel=stylesheet><link href=/css/auto-complete.css?1677150763 rel=stylesheet><link href=/css/atom-one-dark-reasonable.css?1677150763 rel=stylesheet><link href=/css/theme.css?1677150763 rel=stylesheet><link href=/css/tabs.css?1677150763 rel=stylesheet><link href=/css/hugo-theme.css?1677150763 rel=stylesheet><script src=/js/jquery-3.3.1.min.js?1677150763></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/kubernetes/deployment/gitlab/gitlab/><nav id=sidebar><div id=header-wrapper><div id=header><a id=logo href=/><svg id="grav-logo" style="width:100%;height:100%" viewBox="0 0 504 140" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:1.41421"><path d="M235.832 71.564l-7.98-.001c-1.213.001-2.197.987-2.197 2.204v15.327l-.158.132c-4.696 3.962-10.634 6.14-16.719 6.14-14.356.0-26.034-11.68-26.034-26.037.0-14.358 11.678-26.035 26.034-26.035 5.582.0 10.919 1.767 15.437 5.113.877.649 2.093.56 2.866-.211l5.69-5.69c.444-.442.675-1.055.639-1.681-.034-.627-.336-1.206-.828-1.597-6.76-5.363-15.214-8.314-23.805-8.314-21.18.0-38.414 17.233-38.414 38.415.0 21.183 17.234 38.415 38.414 38.415 10.937.0 21.397-4.705 28.698-12.914.358-.403.556-.921.556-1.46V73.767c0-1.217-.985-2.203-2.2-2.203" style="fill:#000;fill-rule:nonzero"/><path d="M502.794 34.445c-.408-.616-1.1-.989-1.838-.989h-8.684c-.879.0-1.673.522-2.022 1.329l-24.483 56.839-24.92-56.852c-.352-.799-1.142-1.316-2.012-1.316h-8.713c-.744.0-1.44.373-1.843.995-.408.623-.476 1.408-.174 2.09l30.186 68.858c.352.799 1.143 1.317 2.017 1.317H471.3c.879.0 1.673-.527 2.021-1.329l29.655-68.861c.289-.68.222-1.461-.182-2.081" style="fill:#000;fill-rule:nonzero"/><path d="M388.683 34.772c-.353-.798-1.142-1.316-2.017-1.316h-10.988c-.879.0-1.673.522-2.021 1.329l-29.655 68.861c-.294.675-.226 1.46.182 2.077.407.619 1.096.993 1.838.993h8.684c.879.0 1.673-.526 2.022-1.329l24.478-56.842 24.92 56.854c.353.798 1.143 1.317 2.013 1.317h8.717c.744.0 1.44-.374 1.843-.993.408-.624.471-1.41.174-2.094l-30.19-68.857z" style="fill:#000;fill-rule:nonzero"/><path d="M309.196 81.525l.476-.229c8.675-4.191 14.279-13.087 14.279-22.667.0-13.881-11.295-25.174-25.176-25.174h-31.863c-1.214.0-2.199.988-2.199 2.202v68.855c0 1.219.985 2.204 2.199 2.204h7.979c1.214.0 2.2-.985 2.2-2.204V45.833h21.684c7.059.0 12.799 5.739 12.799 12.796.0 5.885-3.996 10.989-9.728 12.408-1.032.261-2.064.393-3.071.393h-7.977c-.829.0-1.585.467-1.959 1.205-.378.74-.305 1.625.187 2.296l22.62 30.884c.412.566 1.07.901 1.771.901h9.915c.827.0 1.587-.467 1.96-1.207.378-.742.302-1.629-.186-2.296l-15.91-21.688z" style="fill:#000;fill-rule:nonzero"/><path d="M107.191 80.969c-7.255-4.794-11.4-8.845-15.011-16.109-2.47 4.977-8.236 12.376-17.962 18.198-4.856 15.106-27.954 44.015-35.43 39.916-2.213-1.212-2.633-2.808-2.133-4.456.536-4.129 9.078-13.62 9.078-13.62s.18 1.992 2.913 6.187c-3.609-11.205 5.965-25.031 8.5-29.738 3.985-1.269 4.274-6.387 4.274-6.387.255-7.909-3.278-13.635-6.701-17.059 2.459 3.002 3.255 7.539 3.372 11.694v.023c.012.469.012.93.011 1.39-.117 3.439-1.157 8.19-3.383 8.19l.006.03c-2.289-.098-5.115.391-7.639 1.18l-5.582 1.334s2.977-.136 4.584 1.252c-1.79 2.915-5.769 6.533-10.206 8.588-6.457 2.995-8.312-2.964-5.034-6.838.805-.946 1.618-1.745 2.387-2.399-.495-.513-.807-1.198-.889-2.068-.001-.005-.004-.009-.005-.013-.45-1.977-.202-4.543 2.596-8.623.551-.863 1.214-1.748 2.007-2.647.025-.031.046-.059.072-.089.034-.042.072-.08.108-.121.02-.023.039-.045.059-.068.2-.228.413-.45.639-.663 3.334-3.414 8.599-6.966 16.897-10.152 9.675-14.223 13.219-16.89 13.219-16.89 1.071-1.096 2.943-2.458 3.632-2.805-5.053-8.781-6.074-21.158-4.75-24.493-.107.18-.206.365-.287.556.49-1.143.819-1.509 1.328-2.111 1.381-1.632 6.058-2.488 7.737.971.895 1.844 1.063 4.232 1.034 6.023-3.704-.193-7.063 4.036-7.063 4.036s3.067-1.448 6.879-1.473c0 0 1.015.883 2.283 2.542-1.712 3.213-4.524 10.021-2.488 17.168.338 1.408.849 2.619 1.483 3.648.024.045.044.089.069.135.051.066.096.122.144.183 3.368 5.072 9.542 5.665 9.542 5.665-2.906-1.45-5.274-3.76-6.816-6.56-.8-1.498-1.291-2.762-1.592-3.761-1.636-6.313.771-9.999 2.149-12.471 3.17-4.917 8.944-7.893 15.151-7.185 8.712.995 14.968 8.862 13.973 17.571-.608 5.321-3.781 9.723-8.142 12.117 1.049 2.839-.073 6.28-.073 6.28 2.642 3.323 2.758 5.238 2.667 7.017-3.357-.565-6.618 1.701-6.618 1.701s6.476-1.546 10.238 1.81c2.446 2.631 4.078 5.009 5.051 6.766 1.393 2.505 7.859 2.683 7.123 7.188-.737 4.499-5.669 4.542-13.401-.56M69.571.0C31.147.0.0 31.148.0 69.567c0 38.422 31.147 69.573 69.571 69.573 38.42.0 69.568-31.151 69.568-69.573C139.139 31.147 107.991.0 69.571.0" style="fill:#000;fill-rule:nonzero"/><path d="M73.796 51.693c.813-.814.813-2.134.0-2.947-.815-.814-2.133-.814-2.947.0-.815.813-.815 2.133.0 2.947.814.813 2.132.813 2.947.0" style="fill:#000;fill-rule:nonzero"/><path d="M66.445 53.149c-.814.813-.814 2.133.0 2.947.813.814 2.133.814 2.947.0.813-.814.813-2.134.0-2.947-.814-.813-2.134-.813-2.947.0" style="fill:#000;fill-rule:nonzero"/><path d="M79.231 54.233c-1.274-1.274-3.339-1.272-4.611.0l-2.713 2.712c-1.274 1.275-1.274 3.339.0 4.612l2.978 2.978c1.274 1.275 3.338 1.274 4.611.0l2.712-2.712c1.274-1.274 1.274-3.339.0-4.612l-2.977-2.978z" style="fill:#000;fill-rule:nonzero"/><path d="M95.759 41.445c-2.151-2.578 1.869-7.257 4.391-4.463 4.645 5.148-2.237 7.041-4.391 4.463M105.004 44.132c3.442-6.553-1.427-10.381-4.773-13.523-5.36-5.039-10.706-7.217-16.811-.241-6.102 6.977-2.226 15.068 3.356 19.061 5.584 3.994 14.782 1.255 18.228-5.297" style="fill:#000;fill-rule:nonzero"/></svg></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=/js/lunr.min.js?1677150763></script>
<script type=text/javascript src=/js/auto-complete.js?1677150763></script>
<script type=text/javascript>var baseurl="https://www.didida.top/"</script><script type=text/javascript src=/js/search.js?1677150763></script></div><section id=homelinks><ul><li><a class=padding href=/><i class='fas fa-home'></i> Home</a></li></ul></section><div class=highlightable><ul class=topics><li data-nav-id=/kubernetes/ title=Kubernetes class="dd-item
parent"><a href=/kubernetes/>Kubernetes</a><ul><li data-nav-id=/kubernetes/introduction/ title=Introduction class=dd-item><a href=/kubernetes/introduction/>Introduction</a></li><li data-nav-id=/kubernetes/deployment/gitlab/gitlab/ title class="dd-item active"><a href=/kubernetes/deployment/gitlab/gitlab/></a></li><li data-nav-id=/kubernetes/deployment/istio/istio/ title class=dd-item><a href=/kubernetes/deployment/istio/istio/></a></li><li data-nav-id=/kubernetes/deployment/istio/manifests/charts/install-openshift/ title class=dd-item><a href=/kubernetes/deployment/istio/manifests/charts/install-openshift/></a></li><li data-nav-id=/kubernetes/deployment/istio/manifests/charts/readme-helm3/ title class=dd-item><a href=/kubernetes/deployment/istio/manifests/charts/readme-helm3/></a></li><li data-nav-id=/kubernetes/deployment/istio/manifests/charts/readme/ title class=dd-item><a href=/kubernetes/deployment/istio/manifests/charts/readme/></a></li><li data-nav-id=/kubernetes/deployment/istio/manifests/charts/updating-charts/ title class=dd-item><a href=/kubernetes/deployment/istio/manifests/charts/updating-charts/></a></li><li data-nav-id=/kubernetes/deployment/kube/kubernetes/ title class=dd-item><a href=/kubernetes/deployment/kube/kubernetes/></a></li></ul></li><li data-nav-id=/operate-system/ title="Operate System" class=dd-item><a href=/operate-system/>Operate System</a><ul><li data-nav-id=/operate-system/introduction/ title=Introduction class=dd-item><a href=/operate-system/introduction/>Introduction</a></li></ul></li><li data-nav-id=/docker/ title=Docker class=dd-item><a href=/docker/>Docker</a><ul><li data-nav-id=/docker/redis/ title=Redis class=dd-item><a href=/docker/redis/>Redis</a></li><li data-nav-id=/docker/rabbitmq/ title=Rabbitmq class=dd-item><a href=/docker/rabbitmq/>Rabbitmq</a></li><li data-nav-id=/docker/mysql/ title=Mysql class=dd-item><a href=/docker/mysql/>Mysql</a></li><li data-nav-id=/docker/monitor/ title=Monitor class=dd-item><a href=/docker/monitor/>Monitor</a></li><li data-nav-id=/docker/gitlab/ title=Gitlab class=dd-item><a href=/docker/gitlab/>Gitlab</a></li><li data-nav-id=/docker/elk/ title=Elk class=dd-item><a href=/docker/elk/>Elk</a></li><li data-nav-id=/docker/etcd/ title=Etcd class=dd-item><a href=/docker/etcd/>Etcd</a></li></ul></li><li data-nav-id=/compiler/ title=编译器 class=dd-item><a href=/compiler/>编译器</a><ul><li data-nav-id=/compiler/introduction/ title=简介 class=dd-item><a href=/compiler/introduction/>简介</a></li><li data-nav-id=/compiler/a-simple-syntax-directed-translator/ title=简单的语法制导翻译 class=dd-item><a href=/compiler/a-simple-syntax-directed-translator/>简单的语法制导翻译</a></li></ul></li><li data-nav-id=/golang/ title=Golang class=dd-item><a href=/golang/>Golang</a><ul><li data-nav-id=/golang/quick-start/ title=入门 class=dd-item><a href=/golang/quick-start/>入门</a><ul><li data-nav-id=/golang/quick-start/install/ title=安装 class=dd-item><a href=/golang/quick-start/install/>安装</a></li><li data-nav-id=/golang/quick-start/quick-start/ title=语言特性 class=dd-item><a href=/golang/quick-start/quick-start/>语言特性</a></li></ul></li></ul></li><li data-nav-id=/leetcode/ title=LeetCode class=dd-item><a href=/leetcode/>LeetCode</a></li></ul><section id=footer><div style="width:300px;margin:0 auto;padding:20px 0"><a target=_blank href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=41162602000151" style=display:inline-block;text-decoration:none;height:20px;line-height:20px><img src=/images/备案图标.png style=float:left><p style="float:left;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">豫公网安备 41162602000151号</p></a><a target=_blank href="http://beian.miit.gov.cn/?token=e1b4bd48-cad0-4396-a1d3-a2bc126c63ba"><p style="float:center;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">豫ICP备2022028187号-1</p></a><p style="float:center;height:20px;line-height:20px;margin:0 0 0 5px;color:#939393">© Augustu Scofield 2023</p></div></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div><div id=top-bar><div id=breadcrumbs itemscope itemtype=http://data-vocabulary.org/Breadcrumb><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links><a href=/>主页</a> > <a href=/kubernetes/>Kubernetes</a> ></span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><ul><li><a href=#gitlab>Gitlab</a></li><li><a href=#add-kubernetes-cluster>Add Kubernetes Cluster</a></li></ul></li></ul></nav></div></div></div></div><div id=head-tags></div><div id=body-inner><h1></h1><h3 id=gitlab>Gitlab</h3><h4 id=archlinux-install>ArchLinux Install</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo pacman -S postgresql-libs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>yay -S gitlab
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Configure your /etc/webapps/gitlab/gitlab.yml
</span></span><span style=display:flex><span>Set up your redis to run on /run/redis/redis.sock or configure gitlab to use redis TCP
</span></span><span style=display:flex><span>Put a secret bytestring to /etc/webapps/gitlab/secret
</span></span><span style=display:flex><span>Copy /usr/share/webapps/gitlab/config/secrets.yml.example to /etc/webapps/gitlab/secrets.yml and configure it
</span></span><span style=display:flex><span>Setup the database:
</span></span><span style=display:flex><span>$ <span style=color:#f92672>(</span>cd /usr/share/webapps/gitlab <span style=color:#f92672>&amp;&amp;</span> sudo -u gitlab <span style=color:#66d9ef>$(</span>cat environment | xargs<span style=color:#66d9ef>)</span> bundle exec rake gitlab:setup<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Finally run the following commands to check your installation:
</span></span><span style=display:flex><span>$ <span style=color:#f92672>(</span>cd /usr/share/webapps/gitlab <span style=color:#f92672>&amp;&amp;</span> sudo -u gitlab <span style=color:#66d9ef>$(</span>cat environment | xargs<span style=color:#66d9ef>)</span> bundle exec rake gitlab:env:info<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>$ <span style=color:#f92672>(</span>cd /usr/share/webapps/gitlab <span style=color:#f92672>&amp;&amp;</span> sudo -u gitlab <span style=color:#66d9ef>$(</span>cat environment | xargs<span style=color:#66d9ef>)</span> bundle exec rake gitlab:check<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>Optional dependencies <span style=color:#66d9ef>for</span> gitlab
</span></span><span style=display:flex><span>    postgresql: database backend
</span></span><span style=display:flex><span>    python-docutils: reStructuredText markup language support <span style=color:#f92672>[</span>installed<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>    smtp-server: mail server in order to receive mail notifications
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo cp /usr/share/webapps/gitlab/config/secrets.yml.example /etc/webapps/gitlab/secrets.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># postgresql</span>
</span></span><span style=display:flex><span>sudo systemctl start postgresql.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo su - postgres -c <span style=color:#e6db74>&#34;initdb --locale zh_CN.UTF-8 -D &#39;/var/lib/postgres/data&#39;&#34;</span>
</span></span><span style=display:flex><span>sudo usermod -a -G postgres $USER
</span></span><span style=display:flex><span>psql -U postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql -d template1
</span></span><span style=display:flex><span>template1<span style=color:#f92672>=</span><span style=color:#75715e># CREATE USER your_username_here WITH PASSWORD &#39;your_password_here&#39;;</span>
</span></span><span style=display:flex><span>template1<span style=color:#f92672>=</span><span style=color:#75715e># ALTER USER your_username_here SUPERUSER;</span>
</span></span><span style=display:flex><span>template1<span style=color:#f92672>=</span><span style=color:#75715e># CREATE DATABASE gitlabhq_production OWNER your_username_here;</span>
</span></span><span style=display:flex><span>template1<span style=color:#f92672>=</span><span style=color:#75715e># \q</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># redis</span>
</span></span><span style=display:flex><span>sudo vi /etc/redis.conf
</span></span><span style=display:flex><span>unixsocket /var/run/redis/redis.sock
</span></span><span style=display:flex><span>unixsocketperm <span style=color:#ae81ff>770</span>
</span></span><span style=display:flex><span>sudo systemctl restart redis
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vi /etc/webapps/gitlab/gitlab.yml
</span></span><span style=display:flex><span>host: gitlab.org
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hexdump -v -n <span style=color:#ae81ff>64</span> -e <span style=color:#e6db74>&#39;1/1 &#34;%02x&#34;&#39;</span> /dev/urandom &gt; /etc/webapps/gitlab/secret
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>640</span> /etc/webapps/gitlab/secret
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>hexdump -v -n <span style=color:#ae81ff>64</span> -e <span style=color:#e6db74>&#39;1/1 &#34;%02x&#34;&#39;</span> /dev/urandom &gt; /etc/webapps/gitlab-shell/secret
</span></span><span style=display:flex><span>chmod <span style=color:#ae81ff>640</span> /etc/webapps/gitlab-shell/secret
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vi /etc/webapps/gitlab/secrets.yml
</span></span><span style=display:flex><span>production:
</span></span><span style=display:flex><span>  secret_key_base: /etc/webapps/gitlab/secret
</span></span><span style=display:flex><span>  db_key_base: /etc/webapps/gitlab-shell/secret
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo vi /etc/webapps/gitlab/resque.yml
</span></span><span style=display:flex><span>development:
</span></span><span style=display:flex><span>  url: unix:/var/run/redis/redis.sock
</span></span><span style=display:flex><span>test:
</span></span><span style=display:flex><span>  url: unix:/var/run/redis/redis.sock
</span></span><span style=display:flex><span>production:
</span></span><span style=display:flex><span>  url: unix:/var/run/redis/redis.sock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo chown -R gitlab /usr/share/webapps/gitlab/tmp
</span></span><span style=display:flex><span>sudo chmod -R u+rwX /usr/share/webapps/gitlab/tmp
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl start gitlab-gitaly.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cd /usr/share/webapps/gitlab
</span></span><span style=display:flex><span><span style=color:#75715e># sudo -u gitlab $(cat environment | xargs) bundle exec rake gitlab:setup</span>
</span></span><span style=display:flex><span>sudo -u gitlab DISABLE_DATABASE_ENVIRONMENT_CHECK<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>$(</span>cat environment | xargs<span style=color:#66d9ef>)</span> bundle exec rake gitlab:setup
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo -u gitlab <span style=color:#66d9ef>$(</span>cat environment | xargs<span style=color:#66d9ef>)</span> bundle exec rake gitlab:env:info
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl start gitlab-workhorse.service
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo -u gitlab <span style=color:#66d9ef>$(</span>cat environment | xargs<span style=color:#66d9ef>)</span> bundle exec rake gitlab:check
</span></span><span style=display:flex><span><span style=color:#75715e># Init script exists? ... no :) this is ok for we using systemd</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># sudo certbot certonly -d *.didida.top</span>
</span></span><span style=display:flex><span>sudo certbot certonly -d didida.top
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>openssl genpkey -algorithm RSA -out server.key -pkeyopt rsa_keygen_bits:2048
</span></span><span style=display:flex><span>openssl req -new -key ca.key -out ca.csr
</span></span><span style=display:flex><span>openssl x509 -req -days <span style=color:#ae81ff>3650</span> -in ca.csr -signkey ca.key -out ca.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl start nginx redis postgresql gitlab-gitaly gitlab-workhorse gitlab.target
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl status nginx redis postgresql gitlab-gitaly gitlab-workhorse
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo systemctl stop nginx redis postgresql gitlab-gitaly gitlab-workhorse
</span></span></code></pre></div><p>ref: <a href="https://wiki.archlinux.org/index.php?title=GitLab&oldid=647720#Configuration">https://wiki.archlinux.org/index.php?title=GitLab&oldid=647720#Configuration</a></p><h4 id=docker-install>Docker Install</h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run --name gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-p 127.0.0.1:22:22 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-p 127.0.0.1:443:443 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-p 127.0.0.1:80:80 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-d gitlab/gitlab-ce
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>export DATA<span style=color:#f92672>=</span>&lt;ABSOLUTE PATH&gt;
</span></span><span style=display:flex><span>docker run --name gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-p 127.0.0.1:22:22 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-p 127.0.0.1:443:443 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-p 127.0.0.1:80:80 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	--hostname gitlab.org <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v $DATA/gitlab/etc:/etc/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v $DATA/gitlab/opt:/var/opt/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-v $DATA/gitlab/log:/var/log/gitlab <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	-d gitlab/gitlab-ce
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># browser http://localhost:80</span>
</span></span></code></pre></div><h3 id=add-kubernetes-cluster>Add Kubernetes Cluster</h3><p>login -> admin root -> Admin Area -> Kubernetes -> Integrade with a cluster certificate -> Connect existiing cluseter</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># https://gitlab.org/admin/application_settings/network#js-outbound-settings</span>
</span></span><span style=display:flex><span><span style=color:#75715e># check Allow requests to the local network from web hooks and services</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># get kubernetes api url, should be exactly the same</span>
</span></span><span style=display:flex><span>kubectl cluster-info | grep <span style=color:#e6db74>&#39;Kubernetes master&#39;</span> | awk <span style=color:#e6db74>&#39;/http/ {print $NF}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># get kubernetes secrets</span>
</span></span><span style=display:flex><span>kubectl get secrets
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl get secret &lt;SECRETS NAME&gt; -o jsonpath<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;{[&#39;data&#39;][&#39;ca\.crt&#39;]}&#34;</span> | base64 --decode
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>vi gitlab-admin-service-account.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: ServiceAccount
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gitlab
</span></span><span style=display:flex><span>  namespace: kube-system
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>apiVersion: rbac.authorization.k8s.io/v1beta1
</span></span><span style=display:flex><span>kind: ClusterRoleBinding
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: gitlab-admin
</span></span><span style=display:flex><span>roleRef:
</span></span><span style=display:flex><span>  apiGroup: rbac.authorization.k8s.io
</span></span><span style=display:flex><span>  kind: ClusterRole
</span></span><span style=display:flex><span>  name: cluster-admin
</span></span><span style=display:flex><span>subjects:
</span></span><span style=display:flex><span>  - kind: ServiceAccount
</span></span><span style=display:flex><span>    name: gitlab
</span></span><span style=display:flex><span>    namespace: kube-system
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>kubectl apply -f gitlab-admin-service-account.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># get kubernetes token</span>
</span></span><span style=display:flex><span>kubectl -n kube-system describe secret <span style=color:#66d9ef>$(</span>kubectl -n kube-system get secret | grep gitlab | awk <span style=color:#e6db74>&#39;{print $1}&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># add gitlab prometheus PersistentVolume, no need to claim, just add</span>
</span></span><span style=display:flex><span>kubectl apply -f gitlab-pv-volume.yaml
</span></span></code></pre></div><p>ref: <a href=https://docs.gitlab.com/ee/user/project/clusters/add_remove_clusters.html>https://docs.gitlab.com/ee/user/project/clusters/add_remove_clusters.html</a></p><p>ref: <a href=https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-persistent-volume-storage/>https://kubernetes.io/zh/docs/tasks/configure-pod-container/configure-persistent-volume-storage/</a></p><footer class=footline></footer></div></div><div id=navigation><a class="nav nav-prev" href=/kubernetes/introduction/ title=Introduction><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/kubernetes/deployment/istio/istio/ title style=margin-right:0><i class="fa fa-chevron-right"></i></a></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/js/clipboard.min.js?1677150763></script>
<script src=/js/perfect-scrollbar.min.js?1677150763></script>
<script src=/js/perfect-scrollbar.jquery.min.js?1677150763></script>
<script src=/js/jquery.sticky.js?1677150763></script>
<script src=/js/featherlight.min.js?1677150763></script>
<script src=/js/highlight.pack.js?1677150763></script>
<script>hljs.initHighlightingOnLoad()</script><script src=/js/modernizr.custom-3.6.0.js?1677150763></script>
<script src=/js/learn.js?1677150763></script>
<script src=/js/hugo-learn.js?1677150763></script>
<script src=/mermaid/mermaid.js?1677150763></script>
<script>mermaid.initialize({startOnLoad:!0})</script></body></html>